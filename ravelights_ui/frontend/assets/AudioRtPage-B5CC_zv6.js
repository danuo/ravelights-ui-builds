import{Q as O}from"./QPage-Cbhyhk79.js";import{a3 as j,a4 as z,v as U,r as R,x as V,y as b,w as v,a5 as q,a6 as N,z as Q,D as H,E as T,A as F,B as I,C as W,Q as $}from"./index-C64imV-x.js";import{u as L,a as M}from"./uPlot.min-4xhVlTlW.js";import{u as Y}from"./app-store-KGWziJk4.js";import{a}from"./AudioEnums-C20TDQqa.js";import{R as G}from"./ringbuffer-2FsxNW-2.js";import{U as J}from"./uplot-vue-DQ2TpAw2.js";const X=50;let m=null;const Z=j("audio-rt-store",{state:()=>({data:null,subscribers:0,totalTimeFrame:1,intervalId:null,capacity:null}),actions:{async fetchData(){try{const t=await z("/rest/audio-rt");this.capacity==null&&(this.capacity=t.capacity,this.initRingBuffers(),this.setTotalTimeFrame(t.capacity,t.time_unix),this.validateKeys(t));for(const i of Object.values(a))m[i].pushArray(t[i]);const s={};for(const i of Object.values(a))s[i]=m[i].recentAll();this.data=s}catch(t){console.error("Failed to fetch audio data",t)}},initRingBuffers(){if(this.capacity==null||this.capacity<=0){console.warn("initRingBuffers called without valid capacity");return}m={};for(const t of Object.values(a))m[t]=new G(this.capacity)},validateKeys(t){for(const s of Object.values(a))s in t||console.warn(`Key ${s} missing in API response`)},setTotalTimeFrame(t,s){const i=s[0],c=s[s.length-1]-i,u=s.length,l=u>1?u-1:1;this.totalTimeFrame=c/l*t},startFetching(){console.log("startFetching called"),console.log("subscribers:",this.subscribers),this.subscribers>0&&!this.intervalId&&(this.fetchData(),this.intervalId=setInterval(()=>void this.fetchData(),X))},stopFetching(){this.subscribers===0&&this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)},subscribe(){return console.log("subscribed"),this.subscribers++,this.startFetching(),()=>{this.subscribers>0&&this.subscribers--,this.stopFetching()}}}}),ee=U({__name:"AudioRtChartUplot",setup(t){const s=R(!1),i=R(null),_=V(),{settings:c}=b(_),u=Y(),{enable_charts:l}=b(u),w=Z(),{data:S,totalTimeFrame:B}=b(w);let f=null;const d=[a.rms,a.signal_max,a.level,a.level_low_filter,a.level_low,a.level_low_decay,a.level_low_diff,a.level_mid,a.level_high],h=[[],...d.map(()=>[])];let n=null;function C(e){n=e,requestAnimationFrame(()=>{g()})}const p={ms:1,width:y(),height:x(),pxAlign:!1,series:[{label:"time"},...d.map(e=>({label:e,stroke:M[d.indexOf(e)],width:2}))],scales:{x:{time:!0},y:{auto:!1,range:[0,1]}},axes:[{stroke:"#aab1bf",grid:{width:1/devicePixelRatio,stroke:"#596170"}},{stroke:"#aab1bf",grid:{width:1/devicePixelRatio,stroke:"#596170"}}],legend:{show:!0,live:!1},cursor:{show:!1,drag:{x:!1,y:!1},lock:!0}};v(S,e=>{if(!n||!e)return;const o=e.time_unix||[];h[0]=o,d.forEach((r,P)=>{const K=r;h[P+1]=e[K]||[]})});const{width:D,height:E}=L();v([D,E],()=>{g()});function y(){return document.body.clientWidth-32-6}function x(){const o=i.value||null,r=o?o.getBoundingClientRect().top:0;return window.innerHeight-r-50}function g(){const e=y(),o=x();p.width=e,p.height=o,n&&n.setSize({width:e,height:o})}q(()=>{s.value=!0,g()}),N(()=>{s.value=!1}),v([s,l,c],([e,o,r])=>{e&&o&&!r.performance_mode?(A(),console.log("AAAA"),f=w.subscribe(),requestAnimationFrame(k)):A()});function A(){f&&(f(),f=null)}function k(){if(!s.value||!l.value||c.value.performance_mode||!n)return;const e=Date.now(),r={min:e-B.value,max:e};n.setData(h,!1),n.setScale("x",r),requestAnimationFrame(k)}return(e,o)=>T(l)?(F(),Q("div",{key:0,style:{background:"black",overflow:"hidden"},ref_key:"chartContainer",ref:i},[I(T(J),{data:h,options:p,onCreate:C})],512)):H("",!0)}}),le={__name:"AudioRtPage",setup(t){return(s,i)=>(F(),W(O,{class:"flex flex-direction-column"},{default:$(()=>[I(ee)]),_:1}))}};export{le as default};
