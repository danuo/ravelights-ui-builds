import{a4 as B,a5 as D,x as C,r as E,y as P,z as k,w as x,v as K,t as O,A as U,B as R,C as j,F as z,D as q}from"./index-BeSqqPMt.js";import{u as V}from"./useResize-BQ3IKgzS.js";import{a as i}from"./AudioEnums-C20TDQqa.js";import{R as H}from"./ringbuffer-2FsxNW-2.js";import{u as M}from"./uPlot.min-BqCnoSue.js";import{U as N}from"./uplot-vue-BhQPXQT-.js";const W=50;let f=null;const $=B("audio-rt-store",{state:()=>({data:null,subscribers:0,totalTimeFrame:1,intervalId:null,capacity:null}),actions:{async fetchData(){try{const t=await D("/rest/audio-rt");this.capacity==null&&(this.capacity=t.capacity,this.initRingBuffers(),this.setTotalTimeFrame(t.capacity,t.time_unix),this.validateKeys(t));for(const a of Object.values(i))f[a].pushArray(t[a]);const s={};for(const a of Object.values(i))s[a]=f[a].recentAll();this.data=s}catch(t){console.error("Failed to fetch audio data",t)}},initRingBuffers(){if(this.capacity==null||this.capacity<=0){console.warn("initRingBuffers called without valid capacity");return}f={};for(const t of Object.values(i))f[t]=new H(this.capacity)},validateKeys(t){for(const s of Object.values(i))s in t||console.warn(`Key ${s} missing in API response`)},setTotalTimeFrame(t,s){const a=s[0],c=s[s.length-1]-a,l=s.length,m=l>1?l-1:1;this.totalTimeFrame=c/m*t},startFetching(){console.log("startFetching called"),console.log("subscribers:",this.subscribers),this.subscribers>0&&!this.intervalId&&(this.fetchData(),this.intervalId=setInterval(()=>void this.fetchData(),W))},stopFetching(){this.subscribers===0&&this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)},subscribe(){return console.log("subscribed"),this.subscribers++,this.startFetching(),()=>{this.subscribers>0&&this.subscribers--,this.stopFetching()}}}}),L=C({__name:"AudioRtChartUplot",setup(t){const s=E(null),a=P(),{settings:b}=k(a),c=$(),{data:l,totalTimeFrame:m}=k(c);let u=null;const h=[i.rms,i.signal_max,i.level,i.level_low_filter,i.level_low,i.level_low_decay,i.level_low_diff,i.level_mid,i.level_high],d=[[],...h.map(()=>[])];let n=null;function F(e){n=e,requestAnimationFrame(()=>{_()})}const p={ms:1,width:g(),height:v(),pxAlign:!1,series:[{label:"time"},...h.map(e=>({label:e,stroke:M[h.indexOf(e)],width:2}))],scales:{x:{time:!0},y:{auto:!1,range:[0,1]}},axes:[{stroke:"#aab1bf",grid:{width:1/devicePixelRatio,stroke:"#596170"}},{stroke:"#aab1bf",grid:{width:1/devicePixelRatio,stroke:"#596170"}}],legend:{show:!0,live:!1},cursor:{show:!1,drag:{x:!1,y:!1},lock:!0}};x(l,e=>{if(!n||!e)return;const o=e.time_unix||[];d[0]=o,h.forEach((r,I)=>{const S=r;d[I+1]=e[S]||[]})});const{width:T,height:A}=V();x([T,A],()=>{_()});function g(){return document.body.clientWidth-32-6}function v(){const o=s.value||null,r=o?o.getBoundingClientRect().top:0;return window.innerHeight-r-50}function _(){const e=g(),o=v();p.width=e,p.height=o,n&&n.setSize({width:e,height:o})}K(()=>{w(),u=c.subscribe(),requestAnimationFrame(y)}),O(()=>{w()});function w(){u&&(u(),u=null)}function y(){if(b.value.performance_mode||!n)return;const e=Date.now(),r={min:e-m.value,max:e};n.setData(d,!1),n.setScale("x",r),requestAnimationFrame(y)}return(e,o)=>(R(),U("div",{style:{background:"black",overflow:"hidden"},ref_key:"chartContainer",ref:s},[j(z(N),{data:d,options:p,onCreate:F})],512))}}),tt={__name:"AudioRtPage",setup(t){return(s,a)=>(R(),q(L))}};export{tt as default};
